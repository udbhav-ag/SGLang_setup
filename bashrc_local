#!/bin/bash

# =============================================================================
# Local environment setup for /home/sdp/aditya
# Source this file: source /home/sdp/aditya/.bashrc_local
# =============================================================================

# --- Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# --- Welcome Banner ---
echo -e "${CYAN}"
echo "  ╔═══════════════════════════════════════════════════════════╗"
echo "  ║                                                           ║"
echo -e "  ║   ${WHITE}Welcome back, Udbhav!${CYAN}                 ║"
echo "  ║                                                           ║"
echo -e "  ║   ${PURPLE}▄▀▀▀▀▄  ▄▀▀▀▀▄  ▄▀▀▀▀▄  ▄▀▀▀▀▄  ▄▀▀▀▀▀▀▄${CYAN}                ║"
echo -e "  ║   ${PURPLE}█    ▀  █      █    █  █   ▄▀  █▄▄▄▄   ▀▄${CYAN}               ║"
echo -e "  ║   ${PURPLE} ▀▄▄▄▄  █      █    █  █▄▄▀▀   █       ▄▀${CYAN}               ║"
echo -e "  ║   ${PURPLE}      █ █▄▄▄▄▄ █▄▄▄▄█  █   █   █▄▄▄▄▄▄▀${CYAN}                 ║"
echo "  ║                                                           ║"
echo "  ╚═══════════════════════════════════════════════════════════╝"
echo -e "${NC}"

# --- SSH Agent Setup ---
# Use a persistent socket file to avoid spawning multiple agents
# --- Your New SSH Agent Setup ---
SSH_ENV="$HOME/.ssh/agent.env"

function start_ssh_agent {
    echo "Initializing new SSH agent..."
    ssh-agent -s | sed 's/^echo/#echo/' > "$SSH_ENV"
    chmod 600 "$SSH_ENV"
    source "$SSH_ENV" > /dev/null
    # This looks for YOUR default key
    ssh-add ~/.ssh/id_rsa 2>/dev/null || ssh-add ~/.ssh/id_ed25519 2>/dev/null
}

# Source the env if it exists, otherwise start a new one
if [ -f "$SSH_ENV" ]; then
    source "$SSH_ENV" > /dev/null
    # Check if the agent is actually still alive
    ps -ef | grep "$SSH_AGENT_PID" | grep ssh-agent > /dev/null || start_ssh_agent
else
    start_ssh_agent
fi

# --- YOUR Git Configuration ---
TARGET_DIR="$HOME/Udbhav"
MY_NAME="Udbhav Agarwal"
MY_EMAIL="udbhav.agarwal@scorelabsai.com"

echo "Configuring git settings for all repositories in $TARGET_DIR..."

find "$TARGET_DIR" -name ".git" -type d 2>/dev/null | while read gitdir; do
    repo_path=$(dirname "$gitdir")
    echo "Updating $repo_path"
    (cd "$repo_path" && \
     git config --local user.name "$MY_NAME" && \
     git config --local user.email "$MY_EMAIL") 2>/dev/null
done

echo "Done!"

export PATH="$HOME/.local/bin:$PATH"


# 1. & 1.1 Miniconda Setup
mkdir -p ~/Udbhav && cd ~/Udbhav
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
bash miniconda.sh -b -u -p ~/Udbhav/miniconda3
rm miniconda.sh

# Initialize
source "$HOME/Udbhav/miniconda3/etc/profile.d/conda.sh"
conda config --set auto_activate_base false >/dev/null 2>&1
conda init bash

# 7. & 8. Modern Build Tools (uv & cmake)
curl -LsSf https://astral.sh/uv/install.sh | sh
source $HOME/.cargo/env
uv pip install --system "cmake>=3.26"

# CUDA paths (Critical for building sgl-kernel)
export PATH="/usr/local/cuda/bin:$PATH"
export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"

# --- Conda (local miniconda3) ---
source "$HOME/Udbhav/miniconda3/etc/profile.d/conda.sh"

# --- HuggingFace Token ---
export HF_TOKEN="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"

# --- GitHub CLI Config ---
export GH_CONFIG_DIR=/home/sdp/aditya/.gh_config


# --- Bash Completion ---
if [ -d "$HOME/.local/share/bash-completion" ]; then
    export BASH_COMPLETION_USER_DIR="$HOME/.local/share/bash-completion"
fi

# --- Man Pages ---
export MANPATH="$HOME/.local/share/man:$MANPATH"

sudo apt update && sudo apt upgrade -y
sudo apt install -y build-essential libnuma-dev btop
sudo apt install -y nvidia-driver-535 nvidia-cuda-toolkit
